substitutions:
  zone_1_name: "Zone 1"
  zone_2_name: "Zone 2"
  zone_3_name: "Zone 3"
  zone_4_name: "Zone 4"
  zone_5_name: "Zone 5"
  zone_6_name: "Zone 6"
  software_version: "ESP32_V1.0"
  sensor_update_frequency: "10s"
  log_level: "info"
  zone_1_valve_id: valve_0
  zone_2_valve_id: valve_1
  zone_3_valve_id: valve_2
  zone_4_valve_id: valve_3
  zone_5_valve_id: valve_4
  zone_6_valve_id: valve_5
  esphome_name: irrigation-esp32
  esphome_comment: "Six Zone ESP32 Irrigation Controller with Flexible Zone 6"
  esphome_project_name: "custom.esp32_irrigation"
  esphome_project_version: ${software_version}
  devicename: irrigation_controller
  upper_devicename: "Irrigation Controller"
  uom: "Min"

esphome:
  name: irrigation-system
  friendly_name: Irrigation System
  project:
    name: ${esphome_project_name}
    version: ${esphome_project_version}
  on_boot:
    priority: -100
    then:
      - text_sensor.template.publish:
          id: valve_status
          state: "System Ready"
      - sprinkler.set_multiplier:
          id: ${devicename}
          multiplier: 1

esp32:
  board: esp32dev
  framework:
    type: esp-idf

logger:
  level: ${log_level}
  logs:
    text_sensor: WARN

api:
  encryption:
    key: "W88o0ykHjhbBwyDmpJbKUfpvvwguEqe/U32xmXcXfoA="

ota:
  platform: esphome
  password: "b1ec0e1fff2e77f6f206e29d48bc299d"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${esphome_name} Fallback"
    password: ""

web_server:
  port: 80

time:
  - platform: homeassistant
    id: homeassistant_time

text:
  - platform: template
    id: schedule_start_time_1
    name: "Schedule Start Time 1 (24hr: 06:00 or 12hr: 6:00 AM)"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    restore_value: true
    entity_category: config
    initial_value: "06:00"

  - platform: template
    id: schedule_start_time_2
    name: "Schedule Start Time 2 (Optional)"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    restore_value: true
    entity_category: config
    initial_value: ""

  - platform: template
    id: schedule_start_time_3
    name: "Schedule Start Time 3 (Optional)"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    restore_value: true
    entity_category: config
    initial_value: ""

  - platform: template
    id: schedule_start_time_4
    name: "Schedule Start Time 4 (Optional)"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    restore_value: true
    entity_category: config
    initial_value: ""

select:
  - platform: template
    id: zone6_mode
    name: "Zone 6 Mode"
    optimistic: true
    restore_value: true
    entity_category: config
    initial_option: "Zone"
    options:
      - "Zone"
      - "Master Valve"
      - "Pump Start Relay"

text_sensor:
  - platform: version
    name: "${esphome_name} ESPHome Version"
    
  - platform: wifi_info
    ip_address:
      name: "${esphome_name} IP"
    ssid:
      name: "${esphome_name} SSID"
    
  - platform: template
    id: time_remaining
    name: "${upper_devicename} Time Remaining"
    update_interval: ${sensor_update_frequency}
    icon: "mdi:timer-sand"
    lambda: |-
      float raw_time = id(${devicename}).time_remaining_active_valve().value_or(0);
      ESP_LOGI("time_debug", "Raw time remaining value: %.2f", raw_time);
      
      int minutes = (int)(raw_time / 60.0);
      int seconds = (int)raw_time % 60;
      
      ESP_LOGI("time_debug", "Calculated: %d minutes, %d seconds", minutes, seconds);
      
      std::string result = std::to_string(minutes) + "m " + std::to_string(seconds) + "s";
      return result;

  - platform: template
    id: progress_percent
    name: "${upper_devicename} Progress %"
    update_interval: ${sensor_update_frequency}
    icon: "mdi:progress-clock"
    lambda: |-
      if (!id(${devicename}).active_valve().has_value()) {
        return std::string("0%");
      }
      int active_valve = id(${devicename}).active_valve().value();
      float total_time = id(${devicename}).valve_run_duration_adjusted(active_valve);
      float remaining_time = id(${devicename}).time_remaining_active_valve().value_or(0);
      if (total_time <= 0) return std::string("0%");
      int progress = round(((total_time - remaining_time) * 100) / total_time);
      return std::to_string(progress) + "%";

  - platform: template
    id: valve_status
    name: "${upper_devicename} Status"
    update_interval: never
    icon: "mdi:information-variant"

sensor:
  - platform: uptime
    name: "${upper_devicename} Uptime"

  - platform: wifi_signal
    name: "${upper_devicename} WiFi Signal"
    update_interval: 60s

number:
  - platform: template
    id: ${zone_1_valve_id}
    name: ${zone_1_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 0
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: ${zone_2_valve_id}
    name: ${zone_2_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 1
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: ${zone_3_valve_id}
    name: ${zone_3_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 2
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: ${zone_4_valve_id}
    name: ${zone_4_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 3
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: ${zone_5_valve_id}
    name: ${zone_5_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 4
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: ${zone_6_valve_id}
    name: ${zone_6_name}
    min_value: 1
    max_value: 120
    step: 1
    unit_of_measurement: ${uom}
    icon: "mdi:timer-outline"
    mode: box
    optimistic: true
    restore_value: true
    initial_value: 2
    set_action:
      - sprinkler.set_valve_run_duration:
          id: ${devicename}
          valve_number: 5
          run_duration: !lambda 'return x * 60;'

  - platform: template
    id: sprinkler_ctrlr_repeat_cycles
    name: "Sprinkler Repeat Cycles"
    min_value: 0
    max_value: 5
    step: 1
    mode: box
    icon: "mdi:water-sync"
    lambda: "return id(${devicename}).repeat();"
    set_action:
      - sprinkler.set_repeat:
          id: ${devicename}
          repeat: !lambda 'return x;'

sprinkler:
  - id: ${devicename}
    main_switch:
      name: "Start/Stop/Resume"
      id: main_switch
    auto_advance_switch: "Auto Advance"
    valve_open_delay: 3s
    repeat_number: "Repeat"
    valves:
      - valve_switch: ${zone_1_name}
        enable_switch: 
          name: "Enable ${zone_1_name}"
          id: irrigation_controller_enable_1
        run_duration_number: ${zone_1_valve_id}
        valve_switch_id: irrigation_controller_1
      - valve_switch: ${zone_2_name}
        enable_switch: 
          name: "Enable ${zone_2_name}"
          id: irrigation_controller_enable_2
        run_duration_number: ${zone_2_valve_id}
        valve_switch_id: irrigation_controller_2
      - valve_switch: ${zone_3_name}
        enable_switch: 
          name: "Enable ${zone_3_name}"
          id: irrigation_controller_enable_3
        run_duration_number: ${zone_3_valve_id}
        valve_switch_id: irrigation_controller_3
      - valve_switch: ${zone_4_name}
        enable_switch: 
          name: "Enable ${zone_4_name}"
          id: irrigation_controller_enable_4
        run_duration_number: ${zone_4_valve_id}
        valve_switch_id: irrigation_controller_4
      - valve_switch: ${zone_5_name}
        enable_switch: 
          name: "Enable ${zone_5_name}"
          id: irrigation_controller_enable_5
        run_duration_number: ${zone_5_valve_id}
        valve_switch_id: irrigation_controller_5
      - valve_switch: ${zone_6_name}
        enable_switch: 
          name: "Enable ${zone_6_name}"
          id: irrigation_controller_enable_6
        run_duration_number: ${zone_6_valve_id}
        valve_switch_id: irrigation_controller_6

button:
  - platform: template
    id: sprinkler_pause
    name: "Pause"
    icon: "mdi:pause"
    on_press:
      then:
        - text_sensor.template.publish:
            id: valve_status
            state: "Paused"
        - sprinkler.pause: ${devicename}

switch:
  - platform: restart
    name: "Restart ${devicename}"

  - platform: template
    id: schedule_enabled
    name: "Schedule Enabled"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  - platform: template
    id: use_12hour_format
    name: "Use 12-Hour Time Format"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config

  - platform: template
    id: monday_enabled
    name: "Schedule: Monday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: tuesday_enabled
    name: "Schedule: Tuesday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: wednesday_enabled
    name: "Schedule: Wednesday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: thursday_enabled
    name: "Schedule: Thursday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: friday_enabled
    name: "Schedule: Friday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: saturday_enabled
    name: "Schedule: Saturday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: template
    id: sunday_enabled
    name: "Schedule: Sunday"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:calendar"

  - platform: gpio
    name: "Relay 1"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_1
    on_turn_on:
      - text_sensor.template.publish:
          id: valve_status
          state: "${zone_1_name} Active"
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_on: irrigation_controller_6
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - delay: 2s
            - lambda: |-
                if (id(irrigation_controller_1).state) {
                  id(irrigation_controller_6).turn_on();
                }
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - lambda: |-
                bool any_zone_active = id(irrigation_controller_2).state || id(irrigation_controller_3).state || id(irrigation_controller_4).state || id(irrigation_controller_5).state;
                if (!any_zone_active) {
                  id(irrigation_controller_6).turn_off();
                }
            - delay: 1s
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_off: irrigation_controller_6
      - text_sensor.template.publish:
          id: valve_status
          state: "Idle"
    pin: 
      number: GPIO32
      inverted: false

  - platform: gpio
    name: "Relay 2"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_2
    on_turn_on:
      - text_sensor.template.publish:
          id: valve_status
          state: "${zone_2_name} Active"
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_on: irrigation_controller_6
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - delay: 2s
            - lambda: |-
                if (id(irrigation_controller_2).state) {
                  id(irrigation_controller_6).turn_on();
                }
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - lambda: |-
                bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_3).state || id(irrigation_controller_4).state || id(irrigation_controller_5).state;
                if (!any_zone_active) {
                  id(irrigation_controller_6).turn_off();
                }
            - delay: 1s
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_off: irrigation_controller_6
      - text_sensor.template.publish:
          id: valve_status
          state: "Idle"
    pin: 
      number: GPIO33
      inverted: false

  - platform: gpio
    name: "Relay 3"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_3
    on_turn_on:
      - text_sensor.template.publish:
          id: valve_status
          state: "${zone_3_name} Active"
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_on: irrigation_controller_6
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - delay: 2s
            - lambda: |-
                if (id(irrigation_controller_3).state) {
                  id(irrigation_controller_6).turn_on();
                }
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - lambda: |-
                bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_2).state || id(irrigation_controller_4).state || id(irrigation_controller_5).state;
                if (!any_zone_active) {
                  id(irrigation_controller_6).turn_off();
                }
            - delay: 1s
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_off: irrigation_controller_6
      - text_sensor.template.publish:
          id: valve_status
          state: "Idle"
    pin: 
      number: GPIO25
      inverted: false

  - platform: gpio
    name: "Relay 4"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_4
    on_turn_on:
      - text_sensor.template.publish:
          id: valve_status
          state: "${zone_4_name} Active"
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_on: irrigation_controller_6
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - delay: 2s
            - lambda: |-
                if (id(irrigation_controller_4).state) {
                  id(irrigation_controller_6).turn_on();
                }
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - lambda: |-
                bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_2).state || id(irrigation_controller_3).state || id(irrigation_controller_5).state;
                if (!any_zone_active) {
                  id(irrigation_controller_6).turn_off();
                }
            - delay: 1s
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_off: irrigation_controller_6
      - text_sensor.template.publish:
          id: valve_status
          state: "Idle"
    pin: 
      number: GPIO26
      inverted: false

  - platform: gpio
    name: "Relay 5"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_5
    on_turn_on:
      - text_sensor.template.publish:
          id: valve_status
          state: "${zone_5_name} Active"
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_on: irrigation_controller_6
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - delay: 2s
            - lambda: |-
                if (id(irrigation_controller_5).state) {
                  id(irrigation_controller_6).turn_on();
                }
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Pump Start Relay";'
          then:
            - lambda: |-
                bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_2).state || id(irrigation_controller_3).state || id(irrigation_controller_4).state;
                if (!any_zone_active) {
                  id(irrigation_controller_6).turn_off();
                }
            - delay: 1s
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Master Valve";'
          then:
            - switch.turn_off: irrigation_controller_6
      - text_sensor.template.publish:
          id: valve_status
          state: "Idle"
    pin: 
      number: GPIO27
      inverted: false

  - platform: gpio
    name: "Relay 6"
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true
    id: irrigation_controller_6
    on_turn_on:
      - lambda: |-
          if (id(zone6_mode).state == "Pump Start Relay") {
            bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_2).state || id(irrigation_controller_3).state || id(irrigation_controller_4).state || id(irrigation_controller_5).state;
            if (!any_zone_active) {
              id(irrigation_controller_6).turn_off();
              return;
            }
          }
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Zone";'
          then:
            - text_sensor.template.publish:
                id: valve_status
                state: "${zone_6_name} Active"
          else:
            - if:
                condition:
                  lambda: 'return id(zone6_mode).state == "Master Valve";'
                then:
                  - text_sensor.template.publish:
                      id: valve_status
                      state: "Master Valve Open"
                else:
                  - text_sensor.template.publish:
                      id: valve_status
                      state: "Pump Running"
    on_turn_off:
      - if:
          condition:
            lambda: 'return id(zone6_mode).state == "Zone";'
          then:
            - text_sensor.template.publish:
                id: valve_status
                state: "Idle"
          else:
            - if:
                condition:
                  lambda: 'return id(zone6_mode).state == "Master Valve";'
                then:
                  - text_sensor.template.publish:
                      id: valve_status
                      state: "Master Valve Closed"
                else:
                  - text_sensor.template.publish:
                      id: valve_status
                      state: "Pump Stopped"
    pin: 
      number: GPIO22
      inverted: false

script:
  - id: run_all_zones
    then:
      - logger.log: "Starting scheduled irrigation cycle"
      - switch.turn_on: main_switch

interval:
  - interval: 1min
    then:
      - lambda: |
          auto time = id(homeassistant_time).now();
          if (!time.is_valid()) {
            return;
          }
          
          if (!id(schedule_enabled).state) {
            return;
          }
          
          int current_hour = time.hour;
          int current_minute = time.minute;
          int weekday = time.day_of_week;
          
          bool day_enabled = false;
          if (weekday == 1 && id(sunday_enabled).state) day_enabled = true;
          else if (weekday == 2 && id(monday_enabled).state) day_enabled = true;
          else if (weekday == 3 && id(tuesday_enabled).state) day_enabled = true;
          else if (weekday == 4 && id(wednesday_enabled).state) day_enabled = true;
          else if (weekday == 5 && id(thursday_enabled).state) day_enabled = true;
          else if (weekday == 6 && id(friday_enabled).state) day_enabled = true;
          else if (weekday == 7 && id(saturday_enabled).state) day_enabled = true;
          
          if (!day_enabled) {
            return;
          }
          
          auto convert_to_24hr = [](const std::string& time_str) -> std::string {
            if (time_str.length() < 6) return time_str;
            
            bool is_pm = (time_str.find("PM") != std::string::npos || time_str.find("pm") != std::string::npos);
            bool is_am = (time_str.find("AM") != std::string::npos || time_str.find("am") != std::string::npos);
            
            if (!is_am && !is_pm) return time_str;
            
            std::string time_part = time_str.substr(0, time_str.find_first_of("AaPp"));
            time_part.erase(std::remove(time_part.begin(), time_part.end(), ' '), time_part.end());
            
            if (time_part.length() < 4 || time_part.find(':') == std::string::npos) {
              return time_str;
            }
            
            size_t colon_pos = time_part.find(':');
            int hour = std::stoi(time_part.substr(0, colon_pos));
            std::string minute_str = time_part.substr(colon_pos + 1);
            
            if (is_pm && hour != 12) {
              hour += 12;
            } else if (is_am && hour == 12) {
              hour = 0;
            }
            
            char result[6];
            snprintf(result, sizeof(result), "%02d:%s", hour, minute_str.c_str());
            return std::string(result);
          };
          
          bool time_matches = false;
          std::string start_times[] = {
            id(schedule_start_time_1).state,
            id(schedule_start_time_2).state,
            id(schedule_start_time_3).state,
            id(schedule_start_time_4).state
          };
          
          for (int i = 0; i < 4; i++) {
            std::string start_time = start_times[i];
            if (start_time.empty()) continue;
            
            std::string normalized_time = convert_to_24hr(start_time);
            
            if (normalized_time.length() == 5 && normalized_time[2] == ':') {
              int schedule_hour = std::stoi(normalized_time.substr(0, 2));
              int schedule_minute = std::stoi(normalized_time.substr(3, 2));
              if (current_hour == schedule_hour && current_minute == schedule_minute) {
                time_matches = true;
                break;
              }
            }
          }
          
          if (time_matches) {
            ESP_LOGI("schedule", "Starting scheduled irrigation");
            id(run_all_zones).execute();
          }

  - interval: 5s
    then:
      - lambda: |-
          if (id(zone6_mode).state == "Pump Start Relay" && id(irrigation_controller_6).state) {
            bool any_zone_active = id(irrigation_controller_1).state || id(irrigation_controller_2).state || id(irrigation_controller_3).state || id(irrigation_controller_4).state || id(irrigation_controller_5).state;
            if (!any_zone_active) {
              id(irrigation_controller_6).turn_off();
            }
          }